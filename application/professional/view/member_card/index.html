<!DOCTYPE html>
<html>
<head>
    <title></title>
    <meta charset="UTF-8">
    <link rel="stylesheet" type="text/css" href="_CSS_/bootstrap.css" />
    <link rel="stylesheet" type="text/css" href="_CSS_/bootstrap-responsive.css" />
    <link rel="stylesheet" type="text/css" href="_CSS_/style.css" />
    <script type="text/javascript" src="_JS_/jquery.js"></script>
    <script type="text/javascript" src="_JS_/bootstrap.js"></script>
    <script type="text/javascript" src="_JS_/ckform.js"></script>
    <script type="text/javascript" src="_JS_/common.js"></script>
    <script type="text/javascript" src="_JS_/bootstrap-paginator.js"></script>
    <script type="text/javascript" src="_LAYDATE_/laydate.js"></script>

    <style type="text/css">
        body {
            padding-bottom: 40px;
        }
        .sidebar-nav {
            padding: 9px 0;
        }

        @media (max-width: 980px) {
            /* Enable use of floated navbar text */
            .navbar-text.pull-right {
                float: none;
                padding-left: 5px;
                padding-right: 5px;
            }
        }
        .lefttable{
        }
        .righttable button{
        	font-size: 8px;
        }
        .member_main{
        	height: 400px;
        }
        input{
        	width:100px;
        }
        input[type='date']{
        	font-size: 8px;
        }
        #cardList tbody tr{
        	cursor:pointer;
        }

    </style>
</head>
<body>
<object id="MWRFATL" style="display:none" classid="CLSID:856964B5-F42F-447B-A37D-ED07E8973ED2"></object>
<form class="form-inline definewidth m20" action="" method="get" id="search_form">
			<select name="company">
				{foreach name="companystatuslist" item='v' key='k'}
		            <option value="{$k}" >{$v}</option>
		    	{/foreach}
		    </select>
    <select name="search_type">
            <option value="3">会员手机号</option>
            <option value="1" >会员名字</option>
            <option value="2">会员卡编号</option>
    </select>
    <input type="text" name="search" class="abc input-default" placeholder="" value="">&nbsp;&nbsp;  
    <button type="button" class="btn btn-primary" onclick="select_member()">查询</button>
    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    <button type="button" class="btn btn-success" id="Cashier">用此卡买单</button>
    <button type="button" class="btn btn-success" id="openCard">开卡</button>
    <button type="button" class="btn btn-success" id="rechargeCard">充值</button>
    <button type="button" class="btn btn-success" id="transferCard">转卡</button>
    <button type="button" class="btn btn-success" id="changeCard">换卡</button>
    <button type="button" class="btn btn-success" id="refundCard">还款</button>
</form>
<div class="member_main" style="width:26%;float:left;margin-left:23px">
<table class="table table-bordered table-hover definewidth m10" class="lefttable"  id='cardList'>
	     
        </table>
        <ul id="cardPage"></ul>
       </div>
<div style="width:71%;float:right;">
<form action="" method="post">
<table class="table table-bordered table-hover definewidth m10" class="righttable">
    <tr>
        <td width="15%" class="tableleft"><button type="button" class="btn btn-default btn-xs" id="readCard">读感应卡</button></td>
        <td colspan=3><input type="text" data='number' placeholder=""/></td>
        <td width="10%" class="tableleft">会员卡类型</td>
        <td>
        	<select disabled data='card_type' style="width:100px"> 
				{foreach name="cardtype" item='v' key='k'}
		        <option value="{$k}" >{$v}</option>
		        {/foreach}
		    </select>
        </td>
    </tr>
    <tr>
        <td class="tableleft">卡状态</td>
        <td>
        	<select disabled data='status' style="width:100px"> 
				{foreach name="statuslist" item='v' key='k'}
		        <option value="{$k}" >{$v}</option>
		        {/foreach}
		    </select>
        </td>
        <td width="10%" class="tableleft">开卡公司</td>
        <td>
        	<select disabled data='company_id' style="width:150px"> 
				{foreach name="companyalllist" item='v' key='k'}
		        <option value="{$k}" >{$v}</option>
		        {/foreach}
		    </select>
        </td>
        <td width="10%" class="tableleft">会员姓名</td>
        <td><input type="text" disabled  data='name'/></td>
    </tr>
    <tr>
        <td class="tableleft">累计充值</td>
        <td><input type="text" disabled  data='recharge'/></td>
    	<td class="tableleft">上次充值</td>
        <td><input type='text' disabled  data='last_recharge' /></td>
        <td class="tableleft">上次充值时间</td>
        <td><input type='text' disabled  data='last_recharge_time' /></td>
    </tr>  
    <tr>
        <td class="tableleft">上次充值地点</td>
        <td>
        	<select disabled data='last_recharge_addr' style="width:150px"> 
				{foreach name="companyalllist" item='v' key='k'}
		        <option value="{$k}" >{$v}</option>
		        {/foreach}
		    </select>
        </td>
    	<td class="tableleft">上次消费</td>
        <td><input type='text' disabled  data='last_consumption' /></td>
        <td class="tableleft">上次消费地点</td>
        <td>
        	<select disabled data='last_consumption_addr' style="width:150px"> 
				{foreach name="companyalllist" item='v' key='k'}
		        <option value="{$k}" >{$v}</option>
		        {/foreach}
		    </select>
        </td>
    </tr>
    <tr>
    	<td class="tableleft">开卡日期</td>
        <td><input type='text' disabled  data='start_time' /></td>
        <td class="tableleft">结束日期</td>
        <td><input type='text' disabled  data='end_time' /></td>
        <td colspan=2 rowspan=2>
       		<table class="table">
	       		<thead>
		       		<tr>
			       		<th style="width:10%">账户类型</th>
			       		<th style="width:10%">余额</th>
			       		<th style="width:10%">欠款额</th>
		       		</tr>
	       		</thead>
	       			<tr>
	       				<td>储值账户</td>
	       				<td data='cash'>0</td>
	       				<td data='cash_arrears'>0</td>
	       			</tr>
	       			<tr>
	       				<td>电子钱包</td>
	       				<td data='ewallet'>0</td>
	       				<td>0</td>
	       			</tr>
	       			<tr>
	       				<td>老疗程系统</td>
	       				<td data='old_cash'>0</td>
	       				<td data='old_cash_arrears'>0</td>
	       			</tr>
       		</table>
        </td>
    </tr>  
    <tr>
        <td width="10%" class="tableleft"><button type="button" class="btn btn-default btn-xs" id="updateRemark">修改备注信息</button></td>
        <td colspan=3><textarea rows=10 style="color:red;width:90%" data='remark'></textarea></td>
    </tr> 
</table>
</form>

<div class="log" style="margin:auto;width:96%">
	<ul id="myTab" class="nav nav-tabs">
	   <li class="active"><a href="#home" data-toggle="tab">会员卡账户信息</a></li>
	   <li><a href="#ios" data-toggle="tab">会员卡账户历史</a></li>
	   <li><a href="#histry" data-toggle="tab">会员卡消费历史</a></li>
	   <li><a href="#caozuo" data-toggle="tab">会员卡操作历史</a></li>
	   <!--<li class="dropdown">
	      <a href="#" id="myTabDrop1" class="dropdown-toggle" 
	         data-toggle="dropdown">Java <b class="caret"></b>
	      </a>
	      <ul class="dropdown-menu" role="menu" aria-labelledby="myTabDrop1">
	         <li><a href="#jmeter" tabindex="-1" data-toggle="tab">
	            jmeter</a>
	         </li>
	         <li><a href="#ejb" tabindex="-1" data-toggle="tab">
	            ejb</a>
	         </li>
	      </ul>
	   </li>-->
	</ul>
	<div id="myTabContent" class="tab-content">
	   <div class="tab-pane fade in active" id="home">
	   		<form method="post" action="" id="member_form">
	      	<table class="table table-bordered table-hover definewidth m10">
	      		<tr>
			        <td colspan="4" style="text-align:center">
			        {php}if(in_array('membercard/edit',$power)){{/php}
			            <button class="btn btn-primary" type="button" onclick="edit_member()">保存</button>
			        {php}}{/php}
			            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
			            <button type="reset" class="btn btn-primary">刷新</button>
			        </td>
			    </tr>
        		<tr>
        		<input type="hidden" name="id" value="" />
        		<td class="tableleft">会员姓名</td>
        		<td><input type="text" name="name" required="required"/></td>
        		<td class="tableleft">性别</td>
        		<td id="sex">
        			<label><input type="radio" name="sex" data-sex=1 value="1" /> 男</label>
            		<label><input type="radio" name="sex" data-sex=2 value="2"/> 女</label>
        		</td>
        		<td class="tableleft">手机号码</td>
        		<td><input type="text" name="mobile_phone" required="required"/></td>
        		</tr>
        		<tr>
        		<td class="tableleft">身份证</td>
        		<td colspan=3><input type="text" name="ID_NO" required="required" style="width:200px"/></td>
        		<td class="tableleft">生日</td>
        		<td><input type="text" name="birthday" id="birthday" style="width:120px"/></td>
        		</tr>
        		<tr>
        		<td class="tableleft">地址</td>
        		<td colspan=3><input type="text" name="address" style="width:200px"/></td>
        		<td class="tableleft">卡可消费地区</td>
        		<td>
        			<select name="company_area">
					{foreach name="companylist" item='v' key='k'}
		            <option value="{$k}" >{$v}</option>
		            {/foreach}
		            </select>
        		</td>
        		</tr>
        		<tr>
        		<td class="tableleft">职业</td>
        		<td><input type="text" name="work"/></td>
        		<td class="tableleft">单位名称</td>
        		<td><input type="text" name="work_unit" style="width:200px"/></td>
        		<td class="tableleft">是否发送消费短信</td>
        		<td id="msn"><label><input type="checkbox" name="is_msn" value='1'/></label></td>
        		</tr>
        	</table>
        	<form>
	   </div>
	   <div class="tab-pane fade" id="ios">
        	<table class="table table-bordered table-hover definewidth m10"  id='accountLog'>
	        </table>
	        <ul id="accountLogPage"></ul>
	   </div>
	   <div class="tab-pane fade" id="histry">
	      <table class="table table-bordered table-hover definewidth m10"  id='consumptionLog'>
	        </table>
	        <ul id="consumptionLogPage"></ul>
	   </div>
	   <div class="tab-pane fade" id="caozuo">
	      <table class="table table-bordered table-hover definewidth m10"  id='operationLog'>
	        </table>
	        <ul id="operationLogPage"></ul>
	   </div>
	</div>
	<script>
	   $(function () {
	      $('#myTab li:eq(0) a').tab('show');
	   });
	</script>
	</div>
</div>
</body>
</html>
<script type="text/javascript">
		laydate({
	    	elem: '#birthday', //需显示日期的元素选择器
		  	event: 'click', //触发事件
		  	format: 'YYYY-MM-DD', //日期格式
		    max: laydate.now(), //最大日期
		});   
		$("#Cashier").click(function(){
			var card_no = $("[data=number]").val();
			//window.open("{:URL('Cashier/index')}?card_no="+card_no);
			window.location.href = "{:URL('Cashier/index')}?card_no="+card_no;
		});
		$("#openCard").click(function(){
			window.location.href = "{:URL('member_card/openCard')}";
		});
		$("#rechargeCard").click(function(){
			window.location.href = "{:URL('member_card/rechargeCard')}";
		});
		$("#transferCard").click(function(){
			window.location.href = "{:URL('member_card/transferCard')}";
		});
		$("#changeCard").click(function(){
			window.location.href = "{:URL('member_card/changeCard')}";
		});
		$("#refundCard").click(function(){
			window.location.href = "{:URL('member_card/refundCard')}";
		});
		//ajax获取会员卡数据
		function initTable() {
		
		    var tbody="";
		    
			$.ajax({  
		   		type: 'POST',  
		   		dataType : "json",
		   		async:false,
		   		url: "{:URL('member_card/cardList')}",//请求的action路径页面
			   	data: {"flag":true},
		   		error: function(){ //请求失败处理函数  
		       		alert('请求失败');  
		   		},
		   		success:function(data){ //请求成功后处理函数。
		       		
		       		 tbody='<thead><tr><th style="width:10%">卡号</th><th style="width:10%">卡类型</th><th style="width:10%">姓名</th><th style="width:10%">手机</th></tr></thead>';
		       		 
		       		 $.each(data.list, function(i, n) {
                          var trs = "";
                          trs += "<tr onclick='loadLog(this)' data-id='" + n.id + "'><td>" + n.card_no + "</td><td>"+n.type+"</td><td>"+n.name+"</td><td>"+n.mobile_phone+"</td></tr>";
                      	  tbody+=trs; 
                     });
                     $("#cardList").html(tbody);  
                     
                     var pageCount = data.pageCount; //取到pageCount的值
					 var currentPage = data.CurrentPage; //得到currentPage
					 
					 var options = {
						bootstrapMajorVersion: 3, //版本
						currentPage: currentPage, //当前页数
						totalPages: pageCount, //总页数
						numberOfPages: 5,
						itemTexts: function (type, page, current) {
							switch (type) {
								case "first":
									return "首页";
								case "prev":
									return "上一页";
								case "next":
									return "下一页";
								case "last":
									return "末页";
								case "page":
									return page;
							}
						},//点击事件，用于通过Ajax来刷新整个list列表
						onPageClicked: function (event, originalEvent, type, page) {
							$.ajax({
								url: "{:URL('member_card/cardList')}",
								type: "Post",
								dataType : "json",
								data: "page=" + page,
								success: function (data) {
								     tbody1='<thead><tr><th style="width:10%">卡号</th><th style="width:10%">卡类型</th><th style="width:10%">姓名</th><th style="width:10%">手机</th></tr></thead>';
								     
									 $.each(data.list, function(i, n) {
										 var trs = "";
				                          trs += "<tr onclick='loadLog(this)' data-id='" + n.id + "'><td>" + n.card_no + "</td><td>"+n.type+"</td><td>"+n.name+"</td><td>"+n.mobile_phone+"</td></tr>";
				                      	  tbody1+=trs; 
				                     });
				                     $("#cardList").html(tbody1);
								}
							});
						}
					};
					$('#cardPage').bootstrapPaginator(options);
		   		}  
			});   				
		}

		//ajax会员卡账户历史
		function initTable1(mid) {
		
		    var tbody="";
		    
			$.ajax({  
		   		type: 'POST',  
		   		dataType : "json",
		   		async:false,
		   		url: "{:URL('member_card/histryLog')}",//请求的action路径页面
			   	data: {"flag":true,"mid":mid},  
		   		error: function(){ //请求失败处理函数  
		       		alert('请求失败');  
		   		},
		   		success:function(data){ //请求成功后处理函数。  
		       		
		       		 //tbody='<thead><tr><th style="width:10%">操作公司</th><th style="width:10%">操作人</th><th style="width:10%">日期</th><th>单号</th><th>类型</th><th>项目</th><th>数量</th><th>金额</th><th>支付方式</th><th>服务技师</th></tr></thead>';
		       		 tbody='<thead><tr><th style="width:10%">操作公司</th><th style="width:10%">操作人</th><th style="width:20%">日期</th><th>账户类型</th><th>操作原因</th><th>单号</th><th>前次余额</th><th>此次金额</th><th>此次余额</th></tr></thead>';
		       		 
		       		 if(data.sta==1){
						$.each(data.list, function(i, n) {
							var trs = "";
				                //trs += "<tr><td>" + n.company_name + "</td><td>"+n.activer_name+"</td><td>"+n.date+"</td><td>"+n.order_no+"</td><td>"+n.active_type+"</td><td>"+n.services_id+"</td><td>"+n.services_count+"</td><td>"+n.cash+"</td><td>"+n.pay_type+"</td><td>"+n.services_family+"</td></tr>";
				                trs += "<tr><td>" + n.company_name + "</td><td>"+n.activer_name+"</td><td>"+n.date+"</td><td>"+n.wallet_type+"</td><td>"+n.active_type+"</td><td>"+n.order_no+"</td><td>"+n.last_balance+"</td><td>"+n.cash+"</td><td>"+n.this_balance+"</td></tr>";
				                tbody+=trs; 
				        });
					}else{
						tbody+='';
						$('#accountLogPage').html('');
					}
                     $("#accountLog").html(tbody);
                     
                     var pageCount = data.pageCount; //取到pageCount的值
					 var currentPage = data.CurrentPage; //得到currentPage
					 
					 var options = {
						bootstrapMajorVersion: 3, //版本
						currentPage: currentPage, //当前页数
						totalPages: pageCount, //总页数
						numberOfPages: 5,
						itemTexts: function (type, page, current) {
							switch (type) {
								case "first":
									return "首页";
								case "prev":
									return "上一页";
								case "next":
									return "下一页";
								case "last":
									return "末页";
								case "page":
									return page;
							}
						},//点击事件，用于通过Ajax来刷新整个list列表
						onPageClicked: function (event, originalEvent, type, page) {
							$.ajax({
								url: "{:URL('member_card/histryLog')}",
								type: "Post",
								dataType : "json",
								data: {"page":page,"mid":mid},  
								success: function (data) {
								      tbody1='<thead><tr><th style="width:10%">操作公司</th><th style="width:10%">操作人</th><th style="width:20%">日期</th><th>账户类型</th><th>操作原因</th><th>单号</th><th>前次余额</th><th>此次金额</th><th>此次余额</th></tr></thead>';
								     if(data.sta==1){
								     	$.each(data.list, function(i, n) {
										 var trs = "";
				                          trs += "<tr><td>" + n.company_name + "</td><td>"+n.activer_name+"</td><td>"+n.date+"</td><td>"+n.wallet_type+"</td><td>"+n.active_type+"</td><td>"+n.order_no+"</td><td>"+n.last_balance+"</td><td>"+n.cash+"</td><td>"+n.this_balance+"</td></tr>";
				                      	  tbody1+=trs; 
				                     	});
								     }else{
								     	tbody1+='';
								     }
									 
				                     $("#accountLog").html(tbody1);
								}
							});
						}
					};
					if(data.sta==1){
						$('#accountLogPage').bootstrapPaginator(options);
					}
		   		}  
			});   				
		}

		//ajax会员卡消费历史
		function initTable2(mid) {
		
		    var tbody="";
		    
			$.ajax({  
		   		type: 'POST',  
		   		dataType : "json",
		   		async:false, 
		   		url: "{:URL('member_card/consumptionLog')}",//请求的action路径页面
			   	data: {"flag":true,"mid":mid},  
		   		error: function(){ //请求失败处理函数  
		       		alert('请求失败');  
		   		},
		   		success:function(data){ //请求成功后处理函数。  
		       		
		       		 tbody='<thead><tr><th style="width:10%">操作公司</th><th style="width:10%">操作人</th><th style="width:10%">日期</th><th>单号</th><th>类型</th><th>项目</th><th>数量</th><th>金额</th><th>支付方式</th><th>服务技师</th></tr></thead>';
		       		 
		       		 if(data.sta==1){
						$.each(data.list, function(i, n) {
							var trs = "";
				                trs += "<tr><td>" + n.company_name + "</td><td>"+n.activer_name+"</td><td>"+n.date+"</td><td>"+n.order_no+"</td><td>"+n.active_type+"</td><td>"+n.services_id+"</td><td>"+n.services_count+"</td><td>"+n.cash+"</td><td>"+n.pay_type+"</td><td>"+n.services_family+"</td></tr>";
				                tbody+=trs; 
				        });
					}else{
						tbody+='';
						$('#consumptionLogPage').html('');
					}
                     $("#consumptionLog").html(tbody);
                     
                     var pageCount = data.pageCount; //取到pageCount的值
					 var currentPage = data.CurrentPage; //得到currentPage
					 
					 var options = {
						bootstrapMajorVersion: 3, //版本
						currentPage: currentPage, //当前页数
						totalPages: pageCount, //总页数
						numberOfPages: 5,
						itemTexts: function (type, page, current) {
							switch (type) {
								case "first":
									return "首页";
								case "prev":
									return "上一页";
								case "next":
									return "下一页";
								case "last":
									return "末页";
								case "page":
									return page;
							}
						},//点击事件，用于通过Ajax来刷新整个list列表
						onPageClicked: function (event, originalEvent, type, page) {
							$.ajax({
								url: "{:URL('member_card/consumptionLog')}",
								type: "Post",
								dataType : "json",
								data: {"page":page,"mid":mid},  
								success: function (data) {
								     tbody1='<thead><tr><th style="width:10%">操作公司</th><th style="width:10%">操作人</th><th style="width:10%">日期</th><th>单号</th><th>类型</th><th>项目</th><th>数量</th><th>金额</th><th>支付方式</th><th>服务技师</th></tr></thead>';
								     if(data.sta==1){
								     	$.each(data.list, function(i, n) {
										 var trs = "";
				                          trs += "<tr><td>" + n.company_name + "</td><td>"+n.activer_name+"</td><td>"+n.date+"</td><td>"+n.order_no+"</td><td>"+n.active_type+"</td><td>"+n.services_id+"</td><td>"+n.services_count+"</td><td>"+n.cash+"</td><td>"+n.pay_type+"</td><td>"+n.services_family+"</td></tr>";
				                      	  tbody1+=trs; 
				                     	});
								     }else{
								     	tbody1+='';
								     }
									 
				                     $("#consumptionLog").html(tbody1);
								}
							});
						}
					};
					if(data.sta==1){
						$('#consumptionLogPage').bootstrapPaginator(options);
					}
		   		}  
			});   				
		}

		//ajax会员卡操作历史
		function initTable3(mid) {
		
		    var tbody="";
		    
			$.ajax({  
		   		type: 'POST',  
		   		dataType : "json",
		   		async:false,
		   		url: "{:URL('member_card/operationLog')}",//请求的action路径页面
			   	data: {"flag":true,"mid":mid},  
		   		error: function(){ //请求失败处理函数  
		       		alert('请求失败');  
		   		},
		   		success:function(data){ //请求成功后处理函数。  
		       		
		       		 tbody='<thead><tr><th style="width:10%">操作公司</th><th style="width:10%">操作人</th><th style="width:20%">日期</th><th>备注</th></tr></thead>';
		       		 
		       		 if(data.sta==1){
						$.each(data.list, function(i, n) {
							var trs = "";
				                trs += "<tr><td>" + n.company_name + "</td><td>"+n.active_name+"</td><td>"+n.date+"</td><td>"+n.mark+"</td></tr>";
				                tbody+=trs; 
				        });
					}else{
						tbody+='';
						$('#operationLogPage').html('');
					}
                     $("#operationLog").html(tbody);
                     
                     var pageCount = data.pageCount; //取到pageCount的值
					 var currentPage = data.CurrentPage; //得到currentPage
					 
					 var options = {
						bootstrapMajorVersion: 3, //版本
						currentPage: currentPage, //当前页数
						totalPages: pageCount, //总页数
						numberOfPages: 5,
						itemTexts: function (type, page, current) {
							switch (type) {
								case "first":
									return "首页";
								case "prev":
									return "上一页";
								case "next":
									return "下一页";
								case "last":
									return "末页";
								case "page":
									return page;
							}
						},//点击事件，用于通过Ajax来刷新整个list列表
						onPageClicked: function (event, originalEvent, type, page) {
							$.ajax({
								url: "{:URL('member_card/operationLog')}",
								type: "Post",
								dataType : "json",
								data: {"page":page,"mid":mid},  
								success: function (data) {
								     tbody1='<thead><tr><th style="width:10%">操作公司</th><th style="width:10%">操作人</th><th style="width:20%">日期</th><th>备注</th></tr></thead>';
								     if(data.sta==1){
								     	$.each(data.list, function(i, n) {
										 var trs = "";
				                          trs += "<tr><td>" + n.company_name + "</td><td>"+n.active_name+"</td><td>"+n.date+"</td><td>"+n.mark+"</td></tr>";
				                      	  tbody1+=trs; 
				                     	});
								     }else{
								     	tbody1+='';
								     }
									 
				                     $("#operationLog").html(tbody1);
								}
							});
						}
					};
					if(data.sta==1){
						$('#operationLogPage').bootstrapPaginator(options);
					}
		   		}  
			});   				
		}
		//填充表单
		function fillForm(mid) {
		
			$.ajax({  
		   		type: 'POST',  
		   		dataType : "json",
		   		async:false,
		   		url: "{:URL('member_card/memberInfo')}",//请求的action路径页面
			   	data: {"flag":true,"mid":mid},  
		   		error: function(){ //请求失败处理函数  
		       		alert('请求失败');  
		   		},
		   		success:function(data){
		   			//不能修改的会员卡数据
		   			$('[data=number]').val(data.card_no);
		   			$('[data=mid]').val(data.mid);
		   			$('[data=card_type]').val(data.card_type); 
		   			$('[data=card_type]').find('option[value='+data.card_type+']').attr('selected',true);

		   			$('[data=status]').val(data.status); 
		   			$('[data=status]').find('option[value='+data.status+']').attr('selected',true);

		   			$('[data=company_id]').val(data.company_id); 
		   			$('[data=company_id]').find('option[value='+data.company_id+']').attr('selected',true);

		   			$('[data=name]').val(data.name); 
		   			$('[data=recharge]').val(data.recharge); 
		   			$('[data=last_recharge]').val(data.last_recharge); 
		   			$('[data=last_recharge_time]').val(data.last_recharge_time); 

		   			$('[data=last_recharge_addr]').val(data.last_recharge_addr); 
		   			$('[data=last_recharge_addr]').find('option[value='+data.last_recharge_addr+']').attr('selected',true);

		   			$('[data=last_consumption]').val(data.last_consumption); 

		   			$('[data=last_consumption_addr]').val(data.last_consumption_addr); 
		   			$('[data=last_consumption_addr]').find('option[value='+data.last_consumption_addr+']').attr('selected',true);

		   			$('[data=start_time]').val(data.start_time); 
		   			$('[data=end_time]').val(data.end_time); 
		   			$('[data=remark]').val(data.remark); 
		   			$('[data=cash]').html(data.cash); 
		   			$('[data=cash_arrears]').html(data.cash_arrears); 
		   			$('[data=ewallet]').html(data.ewallet); 
		   			$('[data=old_cash]').html(data.old_cash); 
		   			$('[data=old_cash_arrears]').html(data.old_cash_arrears); 
		   			//能修改的表单中会员数据
		   			$('[name=name]').val(data.name); 
		   			$('[name=mobile_phone]').val(data.mobile_phone); 
		   			$('[name=ID_NO]').val(data.ID_NO); 
		   			$('[name=birthday]').val(data.birthday); 
		   			$('[name=address]').val(data.address); 
		   			$('[name=company_area]').val(data.company_area); 
		   			$('[name=work]').val(data.work); 
		   			$('[name=work_unit]').val(data.work_unit); 
		   			$('[name=id]').val(data.mcid); 

		   			$('option[value='+data.company_area+']').click();

			   		if(data.is_msn==1){
			   			if(!$('[name=is_msn]').attr('checked')){
		   					$('[name=is_msn]').click();
			   			}
		   				$('[name=is_msn]').attr('checked',true);
		   			}else{
		   				if($('[name=is_msn]').attr('checked')){
		   					$('[name=is_msn]').click();
			   			}
		   				$('[name=is_msn]').attr('checked',false);
		   			}

		   			if(data.sex==1){
		   				$('[data-sex=1]').click();
		   				$('[data-sex=1]').attr('checked',true);
		   				$('[data-sex=2]').attr('checked',false);
		   			}else if(data.sex==2){
		   				$('[data-sex=2]').click();
		   				$('[data-sex=2]').attr('checked',true);
		   				$('[data-sex=1]').attr('checked',false);
		   			}

		   		}  
			});   				
		}

		function loadLog(obj){
			if($(obj).attr('class')!='tableleft'){
				var mid = $(obj).data('id');
				$(obj).parent("tbody").find("tr").removeAttr('class');
				$(obj).attr('class','logselected');
				fillForm(mid);
				initTable1(mid);
				initTable2(mid);
				initTable3(mid);
			}
		}
		function edit_member(){
			if($('[name=id]').val()){
				if(confirm('您确认修改会员资料吗？')){
					$.ajax({  
				   		type: 'POST',  
				   		dataType : "json",
				   		async:false,
				   		url: "{:URL('member_card/index')}",//请求的action路径页面
					   	data: $("#member_form").serialize(),  
				   		error: function(){ //请求失败处理函数  
				       		alert('请求失败');  
				   		},
				   		success:function(data){
				   			if(data.status==1){
				   				alert('修改成功');
				   			}else{
				   				alert('修改失败');
				   			}
				   		}  
					});  
				}
			}
		}
		$("#updateRemark").click(function(){
			if($('[name=id]').val()){
				if(confirm('您确认修改备注吗？')){
					$.ajax({  
				   		type: 'POST',  
				   		dataType : "json",
				   		async:false,
				   		url: "{:URL('member_card/index')}",//请求的action路径页面
					   	data: {'remark':$("[data=remark]").val(),'id':$('[name=id]').val()},  
				   		error: function(){ //请求失败处理函数  
				       		alert('请求失败');  
				   		},
				   		success:function(data){
				   			if(data.status==1){
				   				alert('修改成功');
				   			}else{
				   				alert('修改失败');
				   			}
				   		}  
					});  
				}
			}
		});
		function select_member(){

		    var tbody="";
		    
			$.ajax({  
		   		type: 'POST',  
		   		dataType : "json",
		   		async:false,
		   		url: "{:URL('member_card/cardList')}",//请求的action路径页面
			   	data: $("#search_form").serialize(),  
		   		error: function(){ //请求失败处理函数
		       		alert('请求失败');  
		   		},
		   		success:function(data){ //请求成功后处理函数。
		       		
		       		 tbody='<thead><tr><th style="width:10%">卡号</th><th style="width:10%">卡类型</th><th style="width:10%">姓名</th><th style="width:10%">手机</th></tr></thead>';
		       		 
                    if(data.sta==1){
                     	$.each(data.list, function(i, n) {
	                         var trs = "";
	                         trs += "<tr onclick='loadLog(this)' data-id='" + n.id + "'><td>" + n.card_no + "</td><td>"+n.type+"</td><td>"+n.name+"</td><td>"+n.mobile_phone+"</td></tr>";
	                      	 tbody+=trs; 
	                     });
                    }else{
						tbody+='';
						$('#cardListPage').html('');
					}
                     $("#cardList").html(tbody);  
                     
                     var pageCount = data.pageCount; //取到pageCount的值
					 var currentPage = data.CurrentPage; //得到currentPage
					 
					 var options = {
						bootstrapMajorVersion: 3, //版本
						currentPage: currentPage, //当前页数
						totalPages: pageCount, //总页数
						numberOfPages: 5,
						itemTexts: function (type, page, current) {
							switch (type) {
								case "first":
									return "首页";
								case "prev":
									return "上一页";
								case "next":
									return "下一页";
								case "last":
									return "末页";
								case "page":
									return page;
							}
						},//点击事件，用于通过Ajax来刷新整个list列表
						onPageClicked: function (event, originalEvent, type, page) {
							$.ajax({
								url: "{:URL('member_card/cardList')}",
								type: "Post",
								dataType : "json",
								data: $("#search_form").serialize()+"&page=" + page,
								success: function (data) {
								     tbody1='<thead><tr><th style="width:10%">卡号</th><th style="width:10%">卡类型</th><th style="width:10%">姓名</th><th style="width:10%">手机</th></tr></thead>';
								     
									 if(data.sta==1){
				                     	$.each(data.list, function(i, n) {
					                         var trs = "";
					                         trs += "<tr onclick='loadLog(this)' data-id='" + n.id + "'><td>" + n.card_no + "</td><td>"+n.type+"</td><td>"+n.name+"</td><td>"+n.mobile_phone+"</td></tr>";
					                      	 tbody1+=trs; 
					                     });
				                    }else{
										tbody1+='';
										$('#cardListPage').html('');
									}
				                     $("#cardList").html(tbody1);
								}
							});
						}
					};
					$('#cardPage').bootstrapPaginator(options);
		   		}  
			});   	
		}
		$(document).ready(function(){
			initTable();
			$("#readCard").click(function(){
				readerOpen();
				readerBeep();
				var card_code = readMemberCard();
				readerClose();
				if(card_code.card_no){
					$.ajax({  
			   		type: 'POST',  
			   		dataType : "json",
			   		async:false,//是否异步请求
			   		url: "{:URL('member_card/memberEncodeInfoByCardno')}",//请求的action路径页面
				   	data: card_code,
			   		error: function(){ //请求失败处理函数
			       		alert('请求失败');  
			   		},
			   		success:function(data){ //请求成功后处理函数。
			   			if(data.code==0){
			   				alert('暂无该会员,请检查会员卡是否录入错误！');
			   				return false;
			   			}else if(data.code==2){
			   				alert('该卡不是鼎族会员卡！');
			   				return false;
			   			}
			   			//不能修改的会员卡数据
			   			fillForm(data.mcid);
			   			initTable1(data.mcid);
						initTable2(data.mcid);
						initTable3(data.mcid);
			   		}  
				});
			}
		});
		});
		$("[data=number]").blur(function(){
			$.ajax({  
			   		type: 'POST',  
			   		dataType : "json",
			   		async:false,//是否异步请求
			   		url: "{:URL('member_card/memberInfoByCardno')}",//请求的action路径页面
				   	data: {card_no:$("[data=number]").val()},
			   		error: function(){ //请求失败处理函数
			       		alert('请求失败');  
			   		},
			   		success:function(data){ //请求成功后处理函数。
			   			if(data.code==0){
			   				alert('暂无该会员,请检查会员卡是否录入错误！');
			   				return false;
			   			}else if(data.code==2){
			   				alert('该卡不是鼎族会员卡！');
			   				return false;
			   			}
			   			//不能修改的会员卡数据
			   			fillForm(data.mcid);
			   			initTable1(data.mcid);
						initTable2(data.mcid);
						initTable3(data.mcid);
			   		}  
				});
		});
		//打开读写器
        function readerOpen() {
            try {
                var version = MWRFATL.openReader(0, 9600);
                if (MWRFATL.LastRet != 0) {
                    msg.value = "打开读写器失败" +MWRFATL.LastRet + "\n";
                    return;
                }
                else {
                    msg.value = version + "111\n";
                }
            }
            catch (e) {
                //alert(e.Message);
            }
        }
        //读写器鸣响
        function readerBeep() {
            try {
                MWRFATL.readerBeep(30);
                if (MWRFATL.LastRet != 0) {
                    msg.value = msg.value + "读写器鸣响失败" + "\n";
                }
            }
            catch (e) {
                //alert(e.Message);
            }
        }
        //M1卡操作(读取会员卡)
        function readMemberCard() {
        	var area1 = 1;//扇区
        	var area2 = 2;//扇区
            try {
                MWRFATL.openCard(area1, 16); //打开卡片,让其显示16进制字符串卡号
                var result = MWRFATL.cardDirVerifyPassword(0, area1, "ffffffffffff"); //直接密码认证,验证4块所在扇区密码(1扇区),此函数传入的是块号
                if (MWRFATL.LastRet != 0) {
                    alert('该卡不是鼎族会员卡！');
                    return false;
                }
                var code = MWRFATL.cardReadHex(area1);//读取数据

                MWRFATL.openCard(area2, 16); //打开卡片,让其显示16进制字符串卡号
                var result = MWRFATL.cardDirVerifyPassword(0, area2, "ffffffffffff"); //直接密码认证,

                var vip = MWRFATL.cardRead(area2);//读取值

                card_code = {'card_no':vip,'code':code};
                return card_code;
            }
            catch (e) {
            }
        }
        //关闭读写器
        function readerClose() {
            try {
                var result = MWRFATL.closeReader();
                if (MWRFATL.LastRet != 0) {
                    msg.value = msg.value + "关闭读写器失败" + "\n";
                }
                else {
                    msg.value = msg.value + "读写器已关闭" + "\n";
                }
            }
            catch (e) {
                //alert(e.Message);
            }
        }
  </script>
