<!DOCTYPE html>
<html>
<head>
    <title></title>
    <meta charset="UTF-8">
    <link rel="stylesheet" type="text/css" href="_CSS_/bootstrap.css" />
    <link rel="stylesheet" type="text/css" href="_CSS_/bootstrap-responsive.css" />
    <link rel="stylesheet" type="text/css" href="_CSS_/style.css" />
    <script type="text/javascript" src="_JS_/jquery.js"></script>
    <script type="text/javascript" src="_JS_/jquery.sorted.js"></script>
    <script type="text/javascript" src="_JS_/bootstrap.js"></script>
    <script type="text/javascript" src="_JS_/ckform.js"></script>
    <script type="text/javascript" src="_JS_/common.js"></script>
    <style type="text/css">
        body {
            padding-bottom: 40px;
        }
        .sidebar-nav {
            padding: 9px 0;
        }

        @media (max-width: 980px) {
            /* Enable use of floated navbar text */
            .navbar-text.pull-right {
                float: none;
                padding-left: 5px;
                padding-right: 5px;
            }
        }
        .checkboxtd label{
        	display: inline-block;;
        }


    </style>
</head>
<object id="MWRFATL" style="display:none" classid="CLSID:856964B5-F42F-447B-A37D-ED07E8973ED2"></object>
<form action="" method="post">
<table class="table table-bordered table-hover definewidth m10">
    <tr>
        <td class="tableleft"></td>
        <td colspan="3">
		{php}if(in_array('membercard/rechargecard',$power)){{/php}
            <button type="submit" class="btn btn-primary" type="button">保存</button><b id="wait" style="display:none">10</b>&nbsp;&nbsp;
		{php}}{/php}
            <button type="reset" class="btn btn-primary" type="button">刷新</button>&nbsp;&nbsp;<button type="button" class="btn btn-success" id="backid">返回</button>
        </td>
    </tr>
    <tr>
        <td width="10%" class="tableleft">手工单号</td>
        <td><input type="text" name="work_order" id="work_order" required="required" /></td>
        <td width="10%" class="tableleft"><button type="button" class="btn btn-default btn-xs" id="readCard">读感应卡</button></td>
        <td><input type="text" name="card_no" required="required"/></td>
    </tr>
    <tr>
        <td class="tableleft">卡可消费地区</td>
        <td>
        	<select name="company_area">
        	{foreach name="companylist" item='v' key='k'}
            <option value="{$k}">{$v}</option>
            {/foreach}
            </select>
        </td>
        <td width="10%" class="tableleft">会员姓名</td>
        <td>
        	<input type='text' name="name" disabled />
        </td>
    </tr>
    <tr>
        <td width="10%" class="tableleft">充值账户</td>
        <td colspan=3>
        	<select name="wallet" id='wallet'>
        	{foreach name="paylist" item='v' key='k'}
            <option value="{$v.id}">{$v.name}</option>
            {/foreach}
            </select>
        </td>
    </tr>
    <tr>
        <td width="10%" class="tableleft">剩余金额</td>
        <td><input type='number' name="cash" value=0 disabled /></td>
        <td class="tableleft">实收金额</td>
        <td><input type='number' name="real" value=0 /></td>
    </tr>
    <tr>
        <td width="10%" class="tableleft">原欠款金额</td>
        <td><input type='number' name="cash_arrears" value=0 disabled /></td>
        <td class="tableleft">欠款金额</td>
        <td><input type='number' name="arrears" value=0 /></td>
    </tr>
    <tr>
        <td class="tableleft">会员卡类型</td>
        <td>
        	<select name="card_type" disabled="disabled">
        	{foreach name="ctlist" item='v' key='k'}
            <option value="{$v.id}">{$v.name}</option>
            {/foreach}
            </select>
        </td>
        <td class="tableleft">单据总金额</td>
        <td><input type='number' data='total'  value=0 disabled /></td>
    </tr>
    <tr>
    <td class="tableleft">起充金额</td>
        <td colspan=3>
        	<input type='number' data='recharge_standard'  value=0 disabled />
        </td>
    </tr>
    <tr>
        <td colspan='4'>
        <button type="button" class="btn btn-success" id="addpayway">增加支付方式</button>
        	<table class="table table-bordered table-hover definewidth m10" id="payway">
        		<tr>
	        		<th>支付方式</th>
	        		<th>金额</th>
	        		<th>员工工号</th>
	        		<th>分享业绩</th>
	        		<th>操作</th>
        		</tr>
        		<tr>
        			<td>
        				<select name="pay_way[]">
			        	{foreach name="paywaylist" item='v' key='k'}
			            <option value="{$v.id}">{$v.name}</option>
			            {/foreach}
			            </select>
        			</td>
        			<td><input type='number' data='money' name="money[]" value=0 data='money' /></td>
        			<td><input type='text' name="number[]" /></td>
        			<td><input type='text' data='share_results' name="share_results[]" value=0 /></td>
        			<td></td>
        		</tr>
        	</tbale>
        </td>
    </tr>
</table>
</form>
</body>
</html>
<script>
    $(function () {  
    $("input").on('keypress',  //所有input标签回车无效，当然，可以根据需求自定义
		function(e){
			var key = window.event ? e.keyCode : e.which;
			if(key.toString() == "13"){
				e.preventDefault();
			}
		}
	);  
    	$("form").submit(function(e){
    		var out = false;
    		var total = 0;
    		$("form").find('[data=share_results]').each(function(){
    			var sr = $(this).val();
    			var m = $(this).parent('td').parent('tr').find('[data=money]').val();
    			if(m<sr){
    				alert('分享业绩大于实际金额，请重新填写');
    				out = true;
    				return false;
    			}
    		});
    		if(out){
    			return false;
    		}
    		$("[data=money]").each(function(){
			    if($(this).val()<=0){
			    	alert('请输入支付金额!');
			    	out = true;
			    	return false;
			    }
			    total = total+parseInt($(this).val());
			});
    		if(total!=parseInt($("[data=total]").val())){
	    			alert('总金额和支付金额不符！');
	    			return false;
			}

			if(parseInt($("[name=arrears]").val())>0){
				if(parseInt($('#qiandantr').find('[name=money[]]').val())!=parseInt($("[name=arrears]").val())){
					alert('欠款金额与经理签单金额不符！');
					return false;
				}
			}
			var ds = alert_br();
	    	var ct = $("[name=card_type]").val();
	    	var msg = '单号：'+$("[name=work_order]").val()+ds+'会员卡类型：'+$("[name=card_type]").find('[value='+ct+']').html()+ds+'会员姓名：'+$("[name=name]").val()+ds+'实收金额：'+$("[name=real]").val()+ds+"是否确认充值";
	    	if(!confirm(msg)){
	    		return false;
	    	}
	    	resetCashier();
		});
		//判断浏览器类型的换行符
		function alert_br(){
		  if(!document.all)//FF/{谷歌浏览器用这个
		  	{
		    return '\n';
		  }else{  
		  	//IE系列用这个
		    return '\r\n';
		  }
		    return '\r\n';
		}
		
		$('#backid').click(function(){
				window.history.back();
		 });
		document.getElementById("work_order").focus(); 
		$('#addpayway').click(function(){
			$("#payway").append($("#trstr").html());
		});
		$("[name=real]").change(function(){
			var arrears = parseInt($("[name=arrears]").val());
			var real = parseInt($("[name=real]").val());
			if(!arrears){
				arrears = 0;
			}
			if(!real){
				real = 0;
			}
			$("[data=total]").val(eval(arrears+"+"+real));
			//changeCT();
		});
		$("[name=arrears]").change(function(){
			var arrears = parseInt($("[name=arrears]").val());
			var real = parseInt($("[name=real]").val());
			if(!arrears){
				arrears = 0;
			}
			if(!real){
				real = 0;
			}
			$("[data=total]").val(eval(arrears+"+"+real));
			if($(this).val()<=0){
				$("#qiandantr").remove();
			}else{
				if(!$("#qiandantr").html()){
					$("#payway").append($("#qiandan").html());
					$("#qiandantr").find('[data=money]').val($(this).val());
				}
			}
			//changeCT();
		});
		
		$("#wallet").change(function(){
			var card_no = $("[name=card_no]").val();
			var wallet = 7;
			if(card_no){
				$.ajax({  
		   		type: 'POST',  
		   		dataType : "json",
		   		async:true,//是否异步请求
		   		url: "{:URL('member_card/memberInfoByCardno')}",//请求的action路径页面
			   	data: {card_no:$("[name=card_no]").val()},  
		   		error: function(){ //请求失败处理函数
		       		alert('请求失败');  
		   		},
		   		success:function(data){ //请求成功后处理函数。
		   			if(data.code==0){
		   				alert('暂无该会员,请检查会员卡是否录入错误！');
		   				return false;
		   			}
		   			if($("#wallet").val()==7){
		   				$("#wallet").val(7);
		   				$('[name=cash_arrears]').val(data.cash_arrears);
		   				$('[name=cash]').val(data.cash);
		   			}else if($("#wallet").val()==8){
		   				$("#wallet").val(8);
		   				$('[name=cash_arrears]').val(data.ewallent);
		   				$('[name=cash]').val(0);
		   			}else if($("#wallet").val()==9){
		   				$("#wallet").val(9);
		   				$('[name=cash_arrears]').val(data.old_cash);
		   				$('[name=cash]').val(data.old_cash_arrears);
		   			}
		   		}  
			});

			}else{
				alert('读取IC卡');
			}
		});
		$("[name=card_no]").blur(function(){
			var card_no = $("[name=card_no]").val();
			if(card_no){
				$.ajax({  
		   		type: 'POST',  
		   		dataType : "json",
		   		async:true,//是否异步请求
		   		url: "{:URL('member_card/memberInfoByCardno')}",//请求的action路径页面
			   	data: {card_no:$("[name=card_no]").val()},  
		   		error: function(){ //请求失败处理函数
		       		alert('请求失败');  
		   		},
		   		success:function(data){ //请求成功后处理函数。
		   			if(data.code==0){
		   				alert('暂无该会员,请检查会员卡是否录入错误！');
		   				return false;
		   			}
			   			$('[name=card_type]').val(data.card_type); 
			   			$('[name=card_type]').find('option[value='+data.card_type+']').attr('selected',true);

			   			$('[name=name]').val(data.name);

			   			$('[name=company_area]').val(data.company_area); 
			   			$('[name=company_area]').find('option[value='+data.company_area+']').attr('selected',true);

			   			$('[name=wallet]').val(7);
			   			$('[name=wallet]').find('option[value=7]').attr('selected',true);

			   			$('[name=cash_arrears]').val(data.cash_arrears);
			   			$('[name=cash]').val(data.cash);
			   			
			   			$('[data=recharge_standard]').val(data.recharge_standard);

						if(data.is_overdue==1){
			   				alert('请注意，该卡已过期，不能充值！');
			   				return false;
			   			}
			   			if(data.ct_is_true!=1){
			   				alert('本店不能充值该类型会员卡，请联系管理员分发卡类型');
			   				return false;
			   			}
			   			if(data.is_recharge!=1){
			   				alert('请注意，该卡类型不能充值');
			   				return false;
			   			}
		   		}  
			});

			}
		});
		$("#readCard").click(function(){
			readerOpen();
				readerBeep();
				var card_code = readMemberCard();
				readerClose();
				if(card_code.card_no){
					$.ajax({  
			   		type: 'POST',  
			   		dataType : "json",
			   		async:true,//是否异步请求
			   		url: "{:URL('member_card/memberEncodeInfoByCardno')}",//请求的action路径页面
				   	data: card_code,
			   		error: function(){ //请求失败处理函数
			       		alert('请求失败');  
			   		},
			   		success:function(data){ //请求成功后处理函数。
			   			if(data.code==0){
			   				alert('暂无该会员,请检查会员卡是否录入错误！');
			   				return false;
			   			}else if(data.code==2){
			   				alert('该卡不是鼎族会员卡！');
			   				return false;
			   			}
			   			$('[name=card_no]').val(data.card_no); 
			   			$('[name=card_type]').val(data.card_type); 
			   			$('[name=card_type]').find('option[value='+data.card_type+']').attr('selected',true);

			   			$('[name=name]').val(data.name);

			   			$('[name=company_area]').val(data.company_area); 
			   			$('[name=company_area]').find('option[value='+data.company_area+']').attr('selected',true);

			   			$('[name=wallet]').val(7);
			   			$('[name=wallet]').find('option[value=7]').attr('selected',true);

			   			$('[name=cash_arrears]').val(data.cash_arrears);
			   			$('[name=cash]').val(data.cash);
			   			
			   			$('[data=recharge_standard]').val(data.recharge_standard);

			   			if(data.is_overdue==1){
			   				alert('请注意，该卡已过期，不能充值！');
			   				return false;
			   			}
			   			if(data.ct_is_true!=1){
			   				alert('本店不能充值该类型会员卡，请联系管理员分发卡类型');
			   				return false;
			   			}
			   			if(data.is_recharge!=1){
			   				alert('请注意，该卡类型不能充值');
			   				return false;
			   			}

			   		}  
				});

				}
		});

    });
    function remv(obj){
    	$(obj).parent('td').parent('tr').remove();
    }
    //更换卡类型
    function changeCT(){
		var real = $("[name=real]").val();
		var card_no = $("[name=card_no]").val();
		var arrears = $("[name=arrears]").val();
		if(!card_no){
			alert('请先输入会员卡号');
			return false;
		}
		$.ajax({  
				type: 'POST',  
				dataType : "json",
				async:true,//是否异步请求
				url: "{:URL('member_card/getCTbyRecharge')}",//请求的action路径页面
		   		data: {real:real,arrears:arrears,card_no:card_no},  
				error: function(){ //请求失败处理函数
		   			alert('请求失败');  
				},
				success:function(data){ //请求成功后处理函数。
					if(data.status==0){
						alert(data.msg);
						return false;
					}else if(data.status==2){
						return false;
					}
					$('[name=card_type]').val(data.id); 
		   			$('[name=card_type]').find('option[value='+data.id+']').attr('selected',true);
					//$('[name=wallet]').val(7); 
					//$('[name=wallet]').find('option[value=7]').attr('selected',true);

					//$('[name=cash_arrears]').val(data.cash_arrears);
					//$('[name=cash]').val(data.cash);
				}  
		});
	}
    //打开读写器
        function readerOpen() {
            try {
                var version = MWRFATL.openReader(0, 9600);
                if (MWRFATL.LastRet != 0) {
                    msg.value = "打开读写器失败" +MWRFATL.LastRet + "\n";
                    return;
                }
                else {
                    msg.value = version + "111\n";
                }
            }
            catch (e) {
                //alert(e.Message);
            }
        }
        //读写器鸣响
        function readerBeep() {
            try {
                MWRFATL.readerBeep(30);
                if (MWRFATL.LastRet != 0) {
                    msg.value = msg.value + "读写器鸣响失败" + "\n";
                }
            }
            catch (e) {
                //alert(e.Message);
            }
        }
        //M1卡操作
        function writeMemberCard() {
        	var area1 = 1;//扇区
        	var area2 = 2;//扇区
        	var ajaxdata = '';
        	if(!$("[name=newcardid]").val()){
        		alert('请先输入会员卡号');
        		return false;
        	}
        	//查看会员卡是否存在
                $.ajax({  
			   		type: 'POST',  
			   		dataType : "text",
			   		async:false,//是否异步请求
			   		url: "{:URL('member_card/memberEncodeCardno')}",//请求的action路径页面
				   	data: {card_no:$("[name=newcardid]").val()},  
			   		error: function(){ //请求失败处理函数
			       		alert('请求失败');
			   		},
			   		success:function(data){ //请求成功后处理函数。
			   			ajaxdata = data;
			   		}  
				});
            try {
            		if(!ajaxdata){
            			alert('该会员卡已经存在，请更换卡号');
            			return false;
            		}
	                MWRFATL.openCard(area1, 16); //打开卡片,让其显示16进制字符串卡号
	                MWRFATL.cardDirVerifyPassword(0, area1, "ffffffffffff"); //直接密码认证,验证4块所在扇区密码(1扇区),此函数传入的是块号
	                if (MWRFATL.LastRet != 0) {
	                    alert('请把会员卡放在读卡器上或该卡不是鼎族会员卡！');
	                    return false;
	                }
			   			MWRFATL.cardWriteHex(area1,ajaxdata);//写入编码数据
			   			if (MWRFATL.LastRet != 0) {
		                    alert('IC卡写入失败');
		                    return false;
		                }
	                	//var result = MWRFATL.cardReadHex(area1);
			   			

	                	MWRFATL.openCard(area2, 16); //打开卡片,让其显示16进制字符串卡号
	                	MWRFATL.cardDirVerifyPassword(0, area2, "ffffffffffff"); //直接密码认证,

			   			MWRFATL.cardWrite(area2,$("[name=newcardid]").val());//写入数据
			   			if (MWRFATL.LastRet != 0) {
		                    alert('IC卡写入失败');
		                    return false;
		                }
			   			alert("IC卡写入成功");
            }
            catch (e) {
            }
        }
        //M1卡操作(读取会员卡)
        function readMemberCard() {
        	var area1 = 1;//扇区
        	var area2 = 2;//扇区
            try {
                MWRFATL.openCard(area1, 16); //打开卡片,让其显示16进制字符串卡号
                var result = MWRFATL.cardDirVerifyPassword(0, area1, "ffffffffffff"); //直接密码认证,验证4块所在扇区密码(1扇区),此函数传入的是块号
                if (MWRFATL.LastRet != 0) {
                    alert('该卡不是鼎族会员卡！');
                    return false;
                }
                var code = MWRFATL.cardReadHex(area1);//读取数据

                MWRFATL.openCard(area2, 16); //打开卡片,让其显示16进制字符串卡号
                var result = MWRFATL.cardDirVerifyPassword(0, area2, "ffffffffffff"); //直接密码认证,

                var vip = MWRFATL.cardRead(area2);//读取值

                card_code = {'card_no':vip,'code':code};
                return card_code;
            }
            catch (e) {
            }
        }
        //关闭读写器
        function readerClose() {
            try {
                var result = MWRFATL.closeReader();
                if (MWRFATL.LastRet != 0) {
                    msg.value = msg.value + "关闭读写器失败" + "\n";
                }
                else {
                    msg.value = msg.value + "读写器已关闭" + "\n";
                }
            }
            catch (e) {
                //alert(e.Message);
            }
        }
        //点击保存后10秒内不能再次点击
		function resetCashier(){
			var wait = document.getElementById('wait');
			$('[type="submit"]').attr('disabled','1');
			$("#wait").attr('display','block');
	            var interval = setInterval(function(){
	                var time = --wait.innerHTML;
	                if(time <= 0) {
	                    $('[type="submit"]').removeAttr('disabled');
						$("#wait").attr('display','none');
						$("#wait").html(10);
	                    clearInterval(interval);
	                };
	            }, 1000);
		}
</script>
<script type="text/html" id="trstr">
				<tr>
        			<td>
        				<select name="pay_way[]">
			        	{foreach name="paywaylist" item='v' key='k'}
			            <option value="{$v.id}">{$v.name}</option>
			            {/foreach}
			            </select>
        			</td>
        			<td><input type='number' data='money' name="money[]" data='money' value=0 /></td>
        			<td><input type='text' name="number[]" /></td>
        			<td><input type='text' data='share_results' name="share_results[]" value=0 /></td>
        			<td><button type="button" style="font-size: 8px;" class="btn btn-default btn-xs" onclick="remv(this)">删除</button></td>
        		</tr>
</script>
<script type="text/html" id="qiandan">
				<tr id="qiandantr">
        			<td>
        				<input type="hidden" name="pay_way[]" value="14" />
        				签账挂单
        			</td>
        			<td><input type='number' data='money' name="money[]" value=0 data='money' /></td>
        			<td><input type='text' name="number[]" value=0 /></td>
        			<td><input type='text' data='share_results' name="share_results[]" value=0 /></td>
        			<td></td>
        		</tr>
</script>